<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Portal | Misemi-ya University</title>
    
    <!-- Uploadcare -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f6f8fc; color: #333; }

        /* ▼▼▼ VPNロック画面 ▼▼▼ */
        #vpn-lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #vpn-checking { font-size: 1.2rem; color: #555; }
        #vpn-error { display: none; text-align: center; }
        .error-code { font-size: 8rem; font-weight: bold; color: #333; margin: 0; }
        .error-msg { font-size: 1.5rem; color: #666; margin-bottom: 20px; }
        .status-box { background: #f0f0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #555; text-align: left; width: 250px; margin: 0 auto; }

        /* ▼▼▼ メイン画面 ▼▼▼ */
        #main-app { display: none; opacity: 0; transition: opacity 1s; }

        header { background: #003366; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-link { color: white; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .vpn-badge { background: #28a745; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }

        .upload-section {
            background: white; padding: 40px; border-radius: 12px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 40px;
        }
        .upload-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #003366; }
        
        /* Uploadcareボタンのカスタマイズ */
        .uploadcare--widget__button_type_open {
            background-color: #003366 !important;
            color: white !important;
            border-radius: 50px !important;
            padding: 12px 30px !important;
            font-weight: bold !important;
            font-size: 1rem !important;
        }

        .file-list { list-style: none; padding: 0; margin: 0; }
        .file-item {
            background: white; border-radius: 8px; padding: 15px 20px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #003366;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .file-info { display: flex; align-items: center; gap: 15px; font-weight: 500; }
        .file-date { font-size: 0.8rem; color: #999; margin-right: 15px; }
        .file-actions a {
            text-decoration: none; color: white; background: #003366;
            padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; font-weight: bold;
        }
        .file-actions a:hover { background: #002244; }
        .delete-btn {
            background: #dc3545; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; cursor: pointer; margin-left: 10px;
        }
    </style>
</head>
<body>

    <!-- VPNロック画面 -->
    <div id="vpn-lock-screen">
        <div id="vpn-checking">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Security Checking...
        </div>
        <div id="vpn-error">
            <div class="error-code">403</div>
            <div class="error-msg">Access Denied</div>
            <p style="color:#666;">Please connect via the <b>University VPN</b>.</p>
            <div class="status-box">Your IP: <span id="user-ip">...</span></div>
        </div>
    </div>

    <!-- メインアプリ -->
    <div id="main-app">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <a href="https://u.misemi-ya.net/s/l.html" class="back-link">
                    <i class="fa-solid fa-arrow-left"></i> 戻る
                </a>
                <h2>Share Portal</h2>
            </div>
            <span class="vpn-badge"><i class="fa-solid fa-shield-halved"></i> SECURE</span>
        </header>

        <div class="container">
            <div class="upload-section">
                <div class="upload-title"><i class="fa-solid fa-cloud-arrow-up"></i> ファイル共有</div>
                <p style="margin-bottom:20px; color:#666;">ファイルをアップロードすると、学内ネットワークに接続している全員に共有されます。</p>
                
                <!-- 
                   data-input-accept-types="*" : 全てのファイル形式を許可
                   data-system-dialog="true" : エラー回避のためシステムダイアログを使用
                -->
                <input type="hidden" role="uploadcare-uploader" 
                       data-public-key="7c680c46e4cd4508beec" 
                       data-tabs="file camera url" 
                       data-input-accept-types="*"
                       data-system-dialog="true"
                       id="uploader" />
            </div>

            <h3 style="border-bottom:2px solid #ddd; padding-bottom:10px; color:#444;">
                <i class="fa-solid fa-folder-open"></i> 共有ファイル一覧
            </h3>
            <ul id="file-list" class="file-list">
                <div style="text-align:center; padding:20px; color:#999;">読み込み中...</div>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        //  1. VPNチェック
        // ==========================================
        const VPN_HOST = 'public-vpn-129.opengw.net';

        function getSubnet(ip) { 
            return ip ? ip.split('.').slice(0,3).join('.') : ""; 
        }

        async function verifyConnection() {
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const myIp = (await ipRes.json()).ip;
                const dnsRes = await fetch(`https://dns.google/resolve?name=${VPN_HOST}&type=A`);
                const dnsData = await dnsRes.json();
                const vpnIp = dnsData.Answer ? dnsData.Answer[0].data : "Unresolved";

                const mySub = getSubnet(myIp);
                const vpnSub = getSubnet(vpnIp);

                if (vpnIp !== "Unresolved" && mySub === vpnSub) {
                    document.getElementById('vpn-lock-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('vpn-lock-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        setTimeout(() => document.getElementById('main-app').style.opacity = '1', 50);
                    }, 500);
                } else {
                    showError(myIp);
                }
            } catch (e) {
                showError("Network Error");
            }
        }

        function showError(ip) {
            document.getElementById('vpn-checking').style.display = 'none';
            document.getElementById('vpn-error').style.display = 'block';
            document.getElementById('user-ip').textContent = ip;
        }

        // ==========================================
        //  2. Firebase連携
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAuj26lGBWGdcfiLoiCl8s0jTQN3UBu_iM",
            authDomain: "misemiya-portal.firebaseapp.com",
            databaseURL: "https://misemiya-portal-default-rtdb.firebaseio.com",
            projectId: "misemiya-portal",
            storageBucket: "misemiya-portal.firebasestorage.app",
            messagingSenderId: "869803502016",
            appId: "1:869803502016:web:341b0d0d9d6a4f88c00025",
            measurementId: "G-6NQX4H60XC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const filesRef = ref(db, 'sharedFiles');

        // アップロード完了処理
        const widget = uploadcare.Widget('[role=uploadcare-uploader]');
        
        widget.onUploadComplete(function(fileInfo) {
            push(filesRef, {
                name: fileInfo.name,
                url: fileInfo.cdnUrl,
                size: fileInfo.size,
                date: new Date().toLocaleString('ja-JP'),
                timestamp: Date.now()
            })
            .then(() => {
                alert("共有しました！");
                widget.value(null); 
            })
            .catch((error) => {
                console.error("Save Error:", error);
                alert("保存に失敗しました: " + error.message);
            });
        });

        // データ受信 & リスト更新
        onValue(filesRef, (snapshot) => {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                const entries = Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp);

                entries.forEach(([key, file]) => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <div class="file-info">
                            <i class="fa-solid fa-file" style="color:#666; font-size:1.5rem;"></i>
                            <div>
                                <div>${file.name}</div>
                                <div style="font-size:0.8rem; color:#888;">${formatBytes(file.size)}</div>
                            </div>
                        </div>
                        <div class="file-actions" style="display:flex; align-items:center;">
                            <span class="file-date" style="margin-right:15px; font-size:0.8rem; color:#999;">${file.date}</span>
                            <a href="${file.url}" target="_blank" download>
                                <i class="fa-solid fa-download"></i> DL
                            </a>
                            <button class="delete-btn" onclick="window.deleteFile('${key}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">共有されたファイルはありません</div>';
            }
        });

        // 削除機能
        window.deleteFile = (key) => {
            if(confirm("削除しますか？")) {
                remove(ref(db, 'sharedFiles/' + key));
            }
        };

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        verifyConnection();
    </script>
</body>
</html>
